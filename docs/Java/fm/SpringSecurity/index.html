<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Java/fm/SpringSecurity">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">SpringSecurity | Computer Science Learn Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zhiyu1998.github.io/Computer-Science-Learn-Notes/docs/Java/fm/SpringSecurity"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SpringSecurity | Computer Science Learn Notes"><meta data-rh="true" name="description" content="- Spring Security 基础"><meta data-rh="true" property="og:description" content="- Spring Security 基础"><link data-rh="true" rel="icon" href="/Computer-Science-Learn-Notes/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://zhiyu1998.github.io/Computer-Science-Learn-Notes/docs/Java/fm/SpringSecurity"><link data-rh="true" rel="alternate" href="https://zhiyu1998.github.io/Computer-Science-Learn-Notes/docs/Java/fm/SpringSecurity" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://zhiyu1998.github.io/Computer-Science-Learn-Notes/docs/Java/fm/SpringSecurity" hreflang="x-default"><link rel="stylesheet" href="/Computer-Science-Learn-Notes/assets/css/styles.afdb522f.css">
<link rel="preload" href="/Computer-Science-Learn-Notes/assets/js/runtime~main.2a55ec46.js" as="script">
<link rel="preload" href="/Computer-Science-Learn-Notes/assets/js/main.1a67b453.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Computer-Science-Learn-Notes/"><div class="navbar__logo"><img src="/Computer-Science-Learn-Notes/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/Computer-Science-Learn-Notes/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Computer Science Learn Notes</b></a><a class="navbar__item navbar__link" href="/Computer-Science-Learn-Notes/docs/intro">主页</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/zhiyu1998/Computer-Science-Learn-Notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/Computer-Science-Learn-Notes/docs/golang/learnInProblem">目录</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/Computer-Science-Learn-Notes/docs/golang/learnInProblem">Go语言</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/Computer-Science-Learn-Notes/docs/frontend/react/">前端</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/Computer-Science-Learn-Notes/docs/fundamental/datastruct">基础知识</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/basic/">Java基础</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/basic/">基础知识</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/concurrent/">并发编程</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/jvm/part1/简介">虚拟机</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/fm/Spring">Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/fm/SpringMVC">SpringMVC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/fm/Mybatis">Mybatis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/fm/SpringBoot">SpringBoot</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/fm/SpringDataJpa">SpringDataJpa</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/fm/SpringSecurity">SpringSecurity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/fm/SpringCloud">SpringCloud</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/docker/main">Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/integration/main">SpringBoot整合其他框架</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/kotlin/">Kotlin with Spring</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/Computer-Science-Learn-Notes/docs/Java/eightpart/giant">Java面试</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/Computer-Science-Learn-Notes/docs/others/personal_tech">其他分享</a></div></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/Computer-Science-Learn-Notes/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">目录</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Java基础</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SpringSecurity</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>SpringSecurity</h1></header><ul><li><a href="#spring-security-%E5%9F%BA%E7%A1%80">Spring Security 基础</a><ul><li><a href="#spring-security-%E5%AF%B9%E6%AF%94-shiro">Spring Security 对比 Shiro</a><ul><li><a href="#spring-security-%E6%A0%B8%E5%BF%83">Spring Security 核心</a></li><li><a href="#%E5%AF%B9%E6%AF%94shiro">对比shiro</a></li></ul></li><li><a href="#http-basic%E8%AE%A4%E8%AF%81%E6%A8%A1%E5%BC%8F">Http Basic认证模式</a><ul><li><a href="#http-basic%E4%B8%8D%E5%A4%9F%E5%AE%89%E5%85%A8%E7%9A%84%E5%8E%9F%E5%9B%A0">Http Basic不够安全的原因</a><ul><li><a href="#postman%E6%B5%8B%E8%AF%95">POSTMAN测试</a></li><li><a href="#httpbasic%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%8E%9F%E7%90%86%E8%AF%B4%E6%98%8E">HttpBasic模式的原理说明</a></li></ul></li></ul></li><li><a href="#hash%E7%AE%97%E6%B3%95">Hash算法</a><ul><li><a href="#passwordencoder-%E6%8E%A5%E5%8F%A3">PasswordEncoder 接口</a><ul><li><a href="#%E6%B5%8B%E8%AF%95">测试</a></li><li><a href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E8%AE%BA">测试结论</a></li></ul></li></ul></li><li><a href="#formlogin%E7%99%BB%E5%BD%95%E6%A8%A1%E5%BC%8F">formLogin登录模式</a><ul><li><a href="#%E8%AE%A4%E8%AF%81%E5%88%9D%E4%BD%93%E9%AA%8C">认证初体验</a><ul><li><a href="#%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E5%8F%8A%E8%B5%84%E6%BA%90%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E7%9A%84%E6%8E%A7%E5%88%B6%E9%87%8D%E8%A6%81">登录认证及资源访问权限的控制【重要】</a></li><li><a href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%92%E8%89%B2">创建自定义角色</a></li><li><a href="#%E5%BC%80%E6%94%BE%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90">开放静态资源</a></li></ul></li><li><a href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">源码解析</a></li><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%AA%8C%E8%AF%81%E7%99%BB%E5%BD%95%E5%A4%84%E7%90%86%E9%87%8D%E8%A6%81">自定义验证登录处理【重要】</a><ul><li><a href="#%E5%90%8E%E7%AB%AF%E5%A4%84%E7%90%86-json">后端处理 [JSON]</a></li><li><a href="#%E5%89%8D%E7%AB%AF%E5%A4%84%E7%90%86">前端处理</a></li></ul></li><li><a href="#session%E4%BC%9A%E8%AF%9D%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%99%A8">Session会话安全管理器</a><ul><li><a href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95">基本用法</a></li><li><a href="#%E4%BB%A5%E4%B8%8B%E6%96%B9%E6%B3%95%E9%83%BD%E6%98%AF%E5%9C%A8httpsecurity%E6%96%B9%E6%B3%95%E4%B8%AD%E5%92%8C%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%AE%9E%E7%8E%B0-">以下方法都是在HttpSecurity方法中和配置中实现 ↓</a></li><li><a href="#session%E8%B6%85%E6%97%B6">session超时</a></li><li><a href="#session%E4%BF%9D%E6%8A%A4">session保护</a></li><li><a href="#cookie%E5%AE%89%E5%85%A8">cookie安全</a></li><li><a href="#%E5%90%8C%E8%B4%A6%E5%8F%B7%E5%A4%9A%E7%AB%AF%E7%99%BB%E5%BD%95%E8%B8%A2%E4%B8%8B%E7%BA%BF">同账号多端登录踢下线</a></li></ul></li></ul></li></ul></li><li><a href="#spring-security-%E8%BF%9B%E9%98%B6%E7%AF%87">Spring Security 进阶篇</a><ul><li><a href="#rbac%E6%9D%83%E9%99%90%E6%A8%A1%E5%9E%8B">RBAC权限模型</a></li><li><a href="#%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BDrbac%E6%95%B0%E6%8D%AE">动态加载RBAC数据</a><ul><li><a href="#%E5%AE%9E%E7%8E%B0dao%E5%B1%82%E6%8E%A5%E5%8F%A3%E5%92%8Cservice%E6%8E%A5%E5%8F%A3">实现Dao层接口和Service接口</a><ul><li><a href="#%E5%AE%9E%E7%8E%B0dao%E5%B1%82">实现Dao层</a></li><li><a href="#%E5%AE%9E%E7%8E%B0service%E5%B1%82">实现Service层</a></li><li><a href="#%E5%AE%9E%E7%8E%B0%E5%90%8E%E7%9A%84%E9%85%8D%E7%BD%AE">实现后的配置</a></li></ul></li><li><a href="#%E8%B5%84%E6%BA%90%E9%89%B4%E6%9D%83%E8%A7%84%E5%88%99">资源鉴权规则</a><ul><li><a href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AArbac%E7%B1%BB">创建一个RBAC类</a></li><li><a href="#%E9%85%8D%E7%BD%AE%E7%B1%BB%E6%9B%B4%E6%8D%A2">配置类更换</a></li></ul></li></ul></li><li><a href="#spel%E6%9D%83%E9%99%90%E8%A1%A8%E8%BE%BE%E5%BC%8F">SPEL权限表达式</a><ul><li><a href="#%E5%B8%B8%E7%94%A8%E6%9D%83%E9%99%90%E8%A1%A8%E8%BE%BE%E5%BC%8F">常用权限表达式</a><ul><li><a href="#permitall%E6%9D%83%E9%99%90%E7%A4%BA%E4%BE%8B">permitALL()权限示例</a></li></ul></li><li><a href="#method%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6">Method表达式安全控制</a></li></ul></li><li><a href="#rememberme-%E8%AE%B0%E4%BD%8F%E6%88%91">RememberMe 记住我</a><ul><li><a href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86">基础知识</a></li><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE">自定义配置</a></li><li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E7%8E%B0">数据库实现</a></li></ul></li><li><a href="#%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95">退出登录</a><ul><li><a href="#%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE">核心配置</a></li><li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%85%8D%E7%BD%AE-1">自定义配置</a></li><li><a href="#%E9%85%8D%E7%BD%AElogoutsuccesshandler">配置LogoutSuccessHandler</a></li></ul></li><li><a href="#%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81">图片验证</a><ul><li><a href="#%E5%BC%95%E5%85%A5kaptcha">引入Kaptcha</a></li><li><a href="#%E5%BC%95%E5%85%A5%E9%85%8D%E7%BD%AE">引入配置</a></li><li><a href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E5%9C%A8session%E4%B8%AD%E7%9A%84%E7%94%9F%E6%88%90">验证码在Session中的生成</a><ul><li><a href="#%E5%88%9B%E5%BB%BA%E9%AA%8C%E8%AF%81%E7%A0%81%E4%BF%A1%E6%81%AF%E7%B1%BB">创建验证码信息类</a></li><li><a href="#%E6%8A%8A%E9%AA%8C%E8%AF%81%E7%A0%81%E4%BC%A0%E5%88%B0session%E5%89%8D%E7%AB%AF">把验证码传到Session前端</a></li><li><a href="#%E5%AE%9E%E7%8E%B0%E5%90%8E%E7%AB%AF%E9%AA%8C%E8%AF%81--%E9%AA%8C%E8%AF%81%E7%A0%81">实现后端验证--验证码</a></li></ul></li></ul></li><li><a href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E7%9A%84%E5%BA%94%E7%94%A8">前后端分离的应用</a><ul><li><a href="#jwt%E5%B7%A5%E5%85%B7%E7%B1%BB">JWT工具类</a><ul><li><a href="#jwt%E5%B7%A5%E5%85%B7%E7%B1%BB%E6%A8%A1%E6%9D%BF-1">JWT工具类模板 1</a><ul><li><a href="#%E5%BC%95%E5%85%A5jwt%E5%B7%A5%E5%85%B7%E5%8C%85">引入JWT工具包</a></li><li><a href="#jwt%E6%A8%A1%E6%9D%BF%E5%BC%95%E5%85%A5">JWT模板引入</a></li><li><a href="#%E8%8E%B7%E5%8F%96token">获取Token</a></li><li><a href="#%E6%8E%A5%E5%8F%A3%E8%AE%BF%E9%97%AE%E9%89%B4%E6%9D%83%E8%BF%87%E6%BB%A4%E5%99%A8">接口访问鉴权过滤器</a></li></ul></li></ul></li><li><a href="#%E9%85%8D%E7%BD%AEcors%E8%A7%A3%E5%86%B3%E8%B7%A8%E7%AB%99%E8%AE%BF%E9%97%AE">配置CORS解决跨站访问</a></li></ul></li></ul></li></ul><h1>Spring Security 基础</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-security-对比-shiro">Spring Security 对比 Shiro<a class="hash-link" href="#spring-security-对比-shiro" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="spring-security-核心">Spring Security 核心<a class="hash-link" href="#spring-security-核心" title="标题的直接链接">​</a></h3><ul><li>Authentication：身份认证，用户登录的验证</li><li>Authorization：访问授权，授权资源的访问权限</li><li>安全防护，防止跨站请求，session攻击等</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="对比shiro">对比shiro<a class="hash-link" href="#对比shiro" title="标题的直接链接">​</a></h3><ul><li>Spring Security对OAuth支持更友好</li><li>Spring Security在网络安全方面更好</li><li>通常来说，shiro入门更加容易，使用起来也非常简单，这也是造成shiro的使用量一直高于Spring Security的主要原因</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="http-basic认证模式">Http Basic认证模式<a class="hash-link" href="#http-basic认证模式" title="标题的直接链接">​</a></h2><p>HttpBasic登录验证模式是Spring Security实现登录验证最简单的一种方式，也可以说是最简陋的一种方式。它的目的并不是保障登录验证的绝对安全，而是提供一种“防君子不防小人”的登录验证。</p><p><strong>如果使用的Spring Boot版本为1.X版本,依赖的Security 4.X版本，那么就无需任何配置，启动项目访问则会弹出默认的httpbasic认证.</strong></p><p>我们现在使用的是spring boot2.0版本（依赖Security 5.X版本），HttpBasic不再是默认的验证模式，在spring security 5.x默认的验证模式已经是表单模式。所以我们要使用Basic模式，需要自己调整一下。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SecurityConfig  extends WebSecurityConfigurerAdapter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void configure (HttpSecurity http) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http.httpBasic()// 开启httpbasic认证</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .and()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .authorizeRequests()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .anyRequest()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .authenticated();// 所有请求都需要登录认证才能访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Spring Boot启动后会出现密码，账号默认：user</p><blockquote><p>Using generated security password: 33ff7198-ce12-4fd4-a24a-0cea0965959d</p></blockquote><p>如果要自定义用户、密码，必须在yaml中配置：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">security</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> admin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="http-basic不够安全的原因">Http Basic不够安全的原因<a class="hash-link" href="#http-basic不够安全的原因" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="postman测试">POSTMAN测试<a class="hash-link" href="#postman测试" title="标题的直接链接">​</a></h4><p>登录认证后，在Header中Authorization对应的值有Basic YWRtaW46YWRtaW4=</p><p>其中YWRtaW46YWRtaW4=通过Base64解密后可以看出</p><p><img loading="lazy" src="/Computer-Science-Learn-Notes/assets/images/base64-0934919dd683cf782a4719514fa54865.png" width="519" height="445" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="httpbasic模式的原理说明">HttpBasic模式的原理说明<a class="hash-link" href="#httpbasic模式的原理说明" title="标题的直接链接">​</a></h4><p>![](./img/httpbasic mode.png)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hash算法">Hash算法<a class="hash-link" href="#hash算法" title="标题的直接链接">​</a></h2><p>Hash算法特别的地方在于它是一种单向算法，用户可以通过hash算法对某个数据生成一段特定长度的唯一hash值，却不能通过这个hash值逆向获取原始数据。因此Hash算法常用在不可还原的密码存储、数据完整性校验等领域。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="passwordencoder-接口">PasswordEncoder 接口<a class="hash-link" href="#passwordencoder-接口" title="标题的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package org.springframework.security.crypto.password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface PasswordEncoder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String encode(CharSequence rawPassword);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean matches(CharSequence rawPassword, String encodedPassword);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    default boolean upgradeEncoding(String encodedPassword) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>encode 加密密码，hash值是不能被逆向解密的。</li><li>matches 用来校验用户输入密码rawPassword，和加密后的hash值encodedPassword是否匹配。</li><li>upgradeEncoding 判断当前的密码是否需要升级。也就是是否需要重新加密？需要的话返回true，不需要的话返回fasle。默认实现是返回false。</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="测试">测试<a class="hash-link" href="#测试" title="标题的直接链接">​</a></h4><p>测试代码：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void bCryptPasswordTetst(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PasswordEncoder passwordEncoder =  new BCryptPasswordEncoder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String rawPassword = &quot;123456&quot;;  //原始密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String encodedPassword = passwordEncoder.encode(rawPassword); //加密后的密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(&quot;原始密码&quot; + rawPassword);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(&quot;加密之后的hash密码:&quot; + encodedPassword);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(rawPassword + &quot;是否匹配&quot; + encodedPassword + &quot;:&quot;   //密码校验：true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       + passwordEncoder.matches(rawPassword, encodedPassword));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(&quot;654321是否匹配&quot; + encodedPassword + &quot;:&quot;   //定义一个错误的密码进行校验:false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       + passwordEncoder.matches(&quot;654321&quot;, encodedPassword));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第一次测试的结果：</p><blockquote><p>原始密码123456
加密之后的hash密码:$2a$10$xgd6LM8FfwgghM.4KLacIugcVxqY5hvvfuTgg9tXZxseiBGBc4GEi
123456是否匹配$2a$10$xgd6LM8FfwgghM.4KLacIugcVxqY5hvvfuTgg9tXZxseiBGBc4GEi:true
654321是否匹配$2a$10$xgd6LM8FfwgghM.4KLacIugcVxqY5hvvfuTgg9tXZxseiBGBc4GEi:false</p></blockquote><p>第二次测试结果：</p><blockquote><p>原始密码123456
加密之后的hash密码:$2a$10$HfB1IINOH2AG6bCbJ67h0OHBkeb.hL/1nwc84rnjTeAG6mXJWXo3m
123456是否匹配$2a$10$HfB1IINOH2AG6bCbJ67h0OHBkeb.hL/1nwc84rnjTeAG6mXJWXo3m:true
654321是否匹配$2a$10$HfB1IINOH2AG6bCbJ67h0OHBkeb.hL/1nwc84rnjTeAG6mXJWXo3m:false</p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="测试结论">测试结论<a class="hash-link" href="#测试结论" title="标题的直接链接">​</a></h4><p>可以看出<strong>对于同一个原始密码，每次加密之后的hash密码都是不一样的</strong>，这是因为<strong>BCrypt产生随机盐</strong>（盐的作用就是每次做出来的菜味道都不一样）</p><p>BCrypt加密后的密码有三个部分，由 $分隔：（共60位）</p><ol><li>&quot;2a&quot;表示 BCrypt 算法版本</li><li>&quot;10&quot;表示算法的强度</li><li>&quot;zt6dUMTjNSyzINTGyiAglu&quot;部分实际上是随机生成的盐。通常来说前 22 个字符是盐，剩余部分是纯文本的实际哈希值</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="formlogin登录模式">formLogin登录模式<a class="hash-link" href="#formlogin登录模式" title="标题的直接链接">​</a></h2><p>Spring Security的登录认证并不需要我们自己去写登录认证的Controller方法，而是使用过滤器UsernamePasswordAuthenticationFilter。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="认证初体验">认证初体验<a class="hash-link" href="#认证初体验" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="登录认证及资源访问权限的控制重要">登录认证及资源访问权限的控制【重要】<a class="hash-link" href="#登录认证及资源访问权限的控制重要" title="标题的直接链接">​</a></h4><ol><li>继承<strong>WebSecurityConfigurerAdapter</strong></li><li>重写configure (HttpSecurity http)</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">protected void configure (HttpSecurity http) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    http.csrf().disable()// 禁用跨站csrf攻击防御</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .formLogin()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .loginPage(&quot;/login.html&quot;) // 一旦用户的请求没有权限就跳转到这个页面</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .loginProcessingUrl(&quot;/login&quot;) // 登录表单form中action的地址，也就是处理认证请求的路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .usernameParameter(&quot;username&quot;) // 登录表单form中用户名输入框input的name名，不修改的话默认是username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .passwordParameter(&quot;password&quot;) // form中密码输入框input的name名，不修改的话默认是password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .defaultSuccessUrl(&quot;/&quot;) // 登录认证成功后默认转跳的路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .and()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .authorizeRequests()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .antMatchers(&quot;/login.html&quot;,&quot;/login&quot;).permitAll()// 不需要通过登录验证就可以被访问的资源路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .antMatchers(&quot;/&quot;,&quot;/biz1&quot;,&quot;/biz2&quot;) // 资源路径匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .hasAnyAuthority(&quot;ROLE_user&quot;,&quot;ROLE_admin&quot;)  // user角色和admin角色都可以访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //                    .antMatchers(&quot;/syslog&quot;,&quot;/sysuser&quot;)  // 资源路径匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //                        .hasAnyRole(&quot;admin&quot;)  // admin角色可以访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .antMatchers(&quot;/syslog&quot;).hasAuthority(&quot;sys:log&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .antMatchers(&quot;/sysuser&quot;).hasAuthority(&quot;sys:user&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .anyRequest()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .authenticated();// 所有请求都需要登录认证才能访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>逻辑小结：</p><ul><li>首先关闭跨站攻击防御（<em>scrf</em>）</li><li>使用.<em>formLogin</em>() 开启模式</li><li>配置登录页、前端传入的账号和密码、成功后跳转</li><li>然后（<em>and</em>）开始认证（<em>authorizeRequests</em>）</li><li>添加认证的跳转地址（<em>antMatchers</em>）和跳转该地址需要的权限（<em>permitAll</em>、<em>hasAuthority</em>）</li><li>最后加上任何请求（<em>anyRequest</em>）和认证才能访问（<em>authenticated</em>）</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建自定义角色">创建自定义角色<a class="hash-link" href="#创建自定义角色" title="标题的直接链接">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void configure(AuthenticationManagerBuilder auth) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auth.inMemoryAuthentication()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .withUser(&quot;user&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .password(passwordEncoder().encode(&quot;123456&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .roles(&quot;user&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .and()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .withUser(&quot;admin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .password(passwordEncoder().encode(&quot;123456&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .authorities(&quot;sys:log&quot;,&quot;sys:user&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //.roles(&quot;admin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .and()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .passwordEncoder(passwordEncoder());//配置BCrypt加密</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public PasswordEncoder passwordEncoder(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new BCryptPasswordEncoder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>inMemoryAuthentication</code>指的是在内存里面存储用户的身份认证和授权信息。</li><li><code>withUser(&quot;user&quot;)</code>用户名是user</li><li><code>password(passwordEncoder().encode(&quot;123456&quot;))</code>密码是加密之后的123456</li><li><code>authorities(&quot;sys:log&quot;,&quot;sys:user&quot;)</code>指的是admin用户拥有资源ID对应的资源访问的的权限：&quot;/syslog&quot;和&quot;/sysuser&quot;</li><li><code>roles()</code>方法用于指定用户的角色，一个用户可以有多个角色</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="开放静态资源">开放静态资源<a class="hash-link" href="#开放静态资源" title="标题的直接链接">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void configure(WebSecurity web) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    web.ignoring().antMatchers(&quot;/css/**&quot;, &quot;/font/**&quot;, &quot;/img/**&quot;, &quot;/js/**&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="源码解析">源码解析<a class="hash-link" href="#源码解析" title="标题的直接链接">​</a></h3><p>登录认证的执行流程</p><p><img loading="lazy" src="/Computer-Science-Learn-Notes/assets/images/authentication_flowpng-8b5be7e9b9e354ba3da1bd670e106fb1.png" width="1409" height="389" class="img_ev3q"></p><p>登录认证的细节</p><p><img loading="lazy" src="/Computer-Science-Learn-Notes/assets/images/authentication_detail-d47fcde5533ba5e606b3ced775895bdc.png" width="660" height="441" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="自定义验证登录处理重要">自定义验证登录处理【重要】<a class="hash-link" href="#自定义验证登录处理重要" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="后端处理-json">后端处理 <!-- -->[JSON]<a class="hash-link" href="#后端处理-json" title="标题的直接链接">​</a></h4><p>预先定义一个前后端处理的JSON类</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package cn.zhiyucs.commons.exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AjaxResponse {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isok;  //请求是否处理成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int code; //请求响应状态码（200、400、500）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String message;  //请求结果描述信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Object data; //请求结果数据（通常用于查询操作）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private AjaxResponse(){}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static AjaxResponse userInputError(String error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AjaxResponse resultBean = new AjaxResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultBean.setIsok(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultBean.setCode(500);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultBean.setMessage(error);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //请求出现异常时的响应数据封装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static AjaxResponse error(CustomException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AjaxResponse resultBean = new AjaxResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultBean.setIsok(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultBean.setCode(e.getCode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultBean.setMessage(e.getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //请求出现异常时的响应数据封装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static AjaxResponse error(CustomExceptionType customExceptionType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     String errorMessage) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AjaxResponse resultBean = new AjaxResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultBean.setIsok(false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultBean.setCode(customExceptionType.getCode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resultBean.setMessage(errorMessage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return resultBean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //请求成功的响应，不带查询数据（用于删除、修改、新增接口）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static AjaxResponse success(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AjaxResponse ajaxResponse = new AjaxResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setIsok(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setCode(200);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setMessage(&quot;请求响应成功!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ajaxResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //请求成功的响应，带有查询数据（用于数据查询接口）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static AjaxResponse success(Object obj){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AjaxResponse ajaxResponse = new AjaxResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setIsok(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setCode(200);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setMessage(&quot;请求响应成功!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setData(obj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ajaxResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //请求成功的响应，带有查询数据（用于数据查询接口）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static AjaxResponse success(Object obj,String message){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AjaxResponse ajaxResponse = new AjaxResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setIsok(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setCode(200);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setMessage(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ajaxResponse.setData(obj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ajaxResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>继承跳转成功处理和失败处理</p><p>成功处理，以下为代码和注意事项：</p><ul><li>记得@Component</li><li>继承的是SavedRequestAwareAuthenticationSuccessHandler</li><li>ObjectMapper是Spring Boot默认集成的JSON数据处理类库Jackson中的类</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyAuthenticationSuccessHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    extends SavedRequestAwareAuthenticationSuccessHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${spring.security.logintype}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String loginType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static ObjectMapper objectMapper = new ObjectMapper();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onAuthenticationSuccess(HttpServletRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        Authentication authentication) throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (loginType.equalsIgnoreCase(&quot;JSON&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.setContentType(&quot;application/json;charset=UTF-8&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            response.getWriter().write(objectMapper.writeValueAsString(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                AjaxResponse.success()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 会帮我们跳转到上一次请求的页面上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            super.onAuthenticationSuccess(request, response, authentication);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>失败处理同理，继承（SimpleUrlAuthenticationFailureHandler）。</p><p>在Spring Security中修改默认的跳转页为自定义的跳转页即可（<em>successHandler</em>、<em>failureHandler</em>）：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http.csrf().disable()// 禁用跨站csrf攻击防御</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .formLogin()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .loginPage(&quot;/login.html&quot;) // 一旦用户的请求没有权限就跳转到这个页面</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .loginProcessingUrl(&quot;/login&quot;) // 登录表单form中action的地址，也就是处理认证请求的路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .usernameParameter(&quot;username&quot;) // 登录表单form中用户名输入框input的name名，不修改的话默认是username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .passwordParameter(&quot;password&quot;) // form中密码输入框input的name名，不修改的话默认是password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //                    .defaultSuccessUrl(&quot;/&quot;) // 登录认证成功后默认转跳的路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .successHandler(mySuccessHandler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .failureHandler(myFailureHandler)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="前端处理">前端处理<a class="hash-link" href="#前端处理" title="标题的直接链接">​</a></h4><p>前端使用Ajax发送登录即可，注意：</p><blockquote><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">button</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag special-attr attr-name" style="color:#00a4db">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function" style="color:#d73a49">login</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">(</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation" style="color:#393A34">)</span><span class="token tag special-attr attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">登陆</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>不是type=&quot;submit&quot;而是button，不然接收到的就是一串JSON（Vue框架忽略）</p><p>然后就可以发起AJAX请求：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">ajax</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/login&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">success</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">resp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token spread operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="session会话安全管理器">Session会话安全管理器<a class="hash-link" href="#session会话安全管理器" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="基本用法">基本用法<a class="hash-link" href="#基本用法" title="标题的直接链接">​</a></h4><p>Spring Security提供4种方式精确的控制会话的创建：</p><ul><li><strong>always</strong>：如果当前请求没有对应的session存在，Spring Security创建一个session。</li><li><strong>ifRequired（默认）</strong>： Spring Security在需要使用到session时才创建session</li><li><strong>never</strong>： Spring Security将永远不会主动创建session，但是如果session在当前应用中已经存在，它将使用该session</li><li><strong>stateless</strong>：Spring Security不会创建或使用任何session。适合于接口型的无状态应用（前后端分离无状态应用），这种方式节省内存资源</li></ul><p>一般不建议修改，如果非要修改session，可以在<strong>参数为：HttpSecurity 函数中修改</strong>：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    .antMatchers(&quot;/syslog&quot;).hasAuthority(&quot;sys:log&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .antMatchers(&quot;/sysuser&quot;).hasAuthority(&quot;sys:user&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .anyRequest()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .authenticated()// 所有请求都需要登录认证才能访问</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .and().sessionManagement()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="以下方法都是在httpsecurity方法中和配置中实现-">以下方法都是在HttpSecurity方法中和配置中实现 ↓<a class="hash-link" href="#以下方法都是在httpsecurity方法中和配置中实现-" title="标题的直接链接">​</a></h4><h4 class="anchor anchorWithStickyNavbar_LWe7" id="session超时">session超时<a class="hash-link" href="#session超时" title="标题的直接链接">​</a></h4><p>在Spring boot应用中有两种设置会话超时时间的方式，Spring Security对这两种方式完全兼容，即：当会话超时之后用户需要重新登录才能访问应用：</p><ul><li>server.servlet.session.timeout=15m</li><li>spring.session.timeout = 15m</li></ul><p>第一种方式是springBoot应用自带的session超时配置，第二种方式是我们使用Spring Session之后，提供的session超时配置。第二种方式的优先级更高。</p><p>超时会话处理：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http.sessionManagement()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .invalidSessionUrl(&quot;/invalidSession.html&quot;);    //非法超时session跳转页面</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="session保护">session保护<a class="hash-link" href="#session保护" title="标题的直接链接">​</a></h4><p>session-fixation-protection 即session的固化保护功能，该功能的目的是一定程度上防止非法用户窃取用户session及cookies信息，进而模拟session的行为。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http.sessionManagement().sessionFixation().migrateSession()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>设置为“<em>none</em>”时，原始会话不会无效</li><li>设置“<em>newSession</em>”后，将创建一个干净的会话，而不会复制旧会话中的任何属性</li><li><code>migrateSession</code> - 即对于同一个cookies的SESSIONID用户，每次登录访问之后访问将创建一个新的HTTP Session会话，旧的HTTP Session会话将无效，并且旧Session会话的属性将被复制。<strong>在Servlet 3.0及其之前的版本，这种方式是默认的</strong></li><li><code>changeSessionId</code> - 这种方式不会创建新的session，作为替代，使用Servlet 容器(<code>HttpServletRequest#changeSessionId()</code>)提供的会话固化保护功能 。<strong>这个选项在Servlet 3.1 (Java EE 7) 或者更新版本的web容器下默认生效。</strong> 每次登录访问之后都更换sessionid，但是没有新建session会话。</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cookie安全">cookie安全<a class="hash-link" href="#cookie安全" title="标题的直接链接">​</a></h4><p>熟悉Session实现原理的朋友一定都知道，提高Cookies的安全性，实际上就是提高session的安全性。在Spring Boot中可以通过配置方式来实现：</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">server.servlet.session.cookie.http-only=true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.servlet.session.cookie.secure=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>httpOnly：如果为true，则浏览器脚本将无法访问cookie</li><li>secure：如果为true，则仅通过HTTPS连接发送cookie，HTTP无法携带cookie</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="同账号多端登录踢下线">同账号多端登录踢下线<a class="hash-link" href="#同账号多端登录踢下线" title="标题的直接链接">​</a></h4><p>核心：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.sessionManagement()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .maximumSessions(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .maxSessionsPreventsLogin(false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .expiredSessionStrategy(new CustomExpiredSessionStrategy())</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><strong>maximumSessions</strong> 表示同一个用户最大的登录数量</li><li><strong>maxSessionsPreventsLogin</strong> 提供两种session保护策略：<ul><li>true表示已经登录就不予许再次登录，</li><li>false表示允许再次登录但是之前的登录账户会被踢下线</li></ul></li><li><strong>expiredSessionStrategy </strong>表示自定义一个session被下线(超时)之后的处理策略。</li></ul><p>如果不使用前后端分离，被踢下线后的策略可以：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CustomExpiredSessionStrategy implements SessionInformationExpiredStrategy {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //页面跳转的处理逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RedirectStrategy redirectStrategy = new DefaultRedirectStrategy();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onExpiredSessionDetected(SessionInformationExpiredEvent event) throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 是跳转html页面，url代表跳转的地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        redirectStrategy.sendRedirect(event.getRequest(), event.getResponse(), &quot;某个url&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果采用前后端分离的JSON，可以使用：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static ObjectMapper objectMapper = new ObjectMapper();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void onExpiredSessionDetected(SessionInformationExpiredEvent event)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //        redirectStrategy.sendRedirect(event.getRequest(), event.getResponse(), &quot;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map.put(&quot;code&quot;, 403);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map.put(&quot;msg&quot;, &quot;您的登录已经超时或者已经在另一台机器登录，您被迫下线。&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            + event.getSessionInformation().getLastRequest());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String json = objectMapper.writeValueAsString(map);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    event.getResponse().setContentType(&quot;application/json;charset=UTF-8&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    event.getResponse().getWriter().write(json);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h1>Spring Security 进阶篇</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rbac权限模型">RBAC权限模型<a class="hash-link" href="#rbac权限模型" title="标题的直接链接">​</a></h2><p>RBAC权限模型（Role-Based Access Control）即：基于角色的权限控制：</p><ul><li>用户：系统接口及功能访问的操作者</li><li>权限：能够访问某接口或者做某操作的授权资格</li><li>角色：具有一类相同操作权限的用户的总称</li></ul><p>RBAC权限模型核心授权逻辑如下：</p><ul><li>某用户是什么角色？</li><li>某角色具有什么权限？</li><li>通过角色的权限推导用户的权限</li></ul><p><img loading="lazy" src="https://gitee.com/kyrzy0416/imagebed/raw/master/img/image-20210527230359492.png" alt="image-20210527230359492" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="动态加载rbac数据">动态加载RBAC数据<a class="hash-link" href="#动态加载rbac数据" title="标题的直接链接">​</a></h2><p>提纲：</p><ul><li>Dao层实现UserDetails接口，设置set方法</li><li>Service层实现UserDetailsService接口，完成loadUserByUsername方法</li><li>配置Security中的configure(AuthenticationManagerBuilder auth)</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="实现dao层接口和service接口">实现Dao层接口和Service接口<a class="hash-link" href="#实现dao层接口和service接口" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="实现dao层">实现Dao层<a class="hash-link" href="#实现dao层" title="标题的直接链接">​</a></h4><p>首先创建自己的DAO层类，实现UserDetails接口：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyUserDetails implements UserDetails</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>加入相应的实体类：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">String password;  //密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String username;  //用户名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boolean accountNonExpired;   //是否没过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boolean accountNonLocked;   //是否没被锁定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boolean credentialsNonExpired;  //密码是否没过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boolean enabled;  //账号是否可用</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>设置对应的实体类</p><blockquote><p> IDEA中Generator -- Setter即可设置成功</p></blockquote><p>实例代码如下：</p><p>注意点（此坑整整浪费了3天时间）：</p><ul><li>在设置enable的时候注意书写enable，不要写成enabled或者其他，不然无法从Mybatis中取出数据，导致默认是false一直登陆不上去！</li><li>在数据库中保存enable字段应使用tinyint</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyUserDetails implements UserDetails {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String password;  //密码</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String username;  //用户名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean accountNonExpired;   //是否没过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean accountNonLocked;   //是否没被锁定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean credentialsNonExpired;  //密码是否没过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean enable;  //账号是否可用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Collection&lt;? extends GrantedAuthority&gt; authorities;  //用户的权限集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return authorities;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getPassword() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isAccountNonExpired() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isAccountNonLocked() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isCredentialsNonExpired() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isEnabled() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setPassword(String password) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(String username) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAccountNonExpired(boolean accountNonExpired) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.accountNonExpired = accountNonExpired;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAccountNonLocked(boolean accountNonLocked) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.accountNonLocked = accountNonLocked;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setCredentialsNonExpired(boolean credentialsNonExpired) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.credentialsNonExpired = credentialsNonExpired;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setEnable(boolean enable) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.enable = enable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAuthorities(Collection&lt;? extends GrantedAuthority&gt; authorities) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.authorities = authorities;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="实现service层">实现Service层<a class="hash-link" href="#实现service层" title="标题的直接链接">​</a></h4><p>首先创建自己的Service层类，实现UserDetailsService接口：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyUserDetailService implements UserDetailsService</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>紧接着实现loadUserByUsername接口（username是在SecurityConfig中的 .usernameParameter(&quot;username&quot;) 获取到的），然后就可以实现loadUserByUsername方法</p><p>在实现接口之前要创建一个查询数据库查询，查询出用户的账号密码和是否可用的信息：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface MyUserDetailsServiceMapper {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //根据userID查询用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Select(&quot;SELECT username,password,enable\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;FROM sys_user u\n&quot; +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;WHERE u.username = #{userId}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyUserDetails findByUserName(@Param(&quot;userId&quot;) String userId);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>创建成功后就可以开始继续实现UserDetailsService接口，首先查询数据库中的基本信息、角色、权限：</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 用户基础数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MyUserDetails userDetails = mapper.findByUserName(username);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (userDetails == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new UsernameNotFoundException(&quot;用户名不存在&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">System.out.println(&quot;current user enable: &quot; + userDetails.isEnabled());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 用户角色列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List&lt;String&gt; roleCodes = mapper.findRoleByUserName(username);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 根据角色列表加载当前用户具有的权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">List&lt;String&gt; authorities = mapper.findAuthorityByRoleCodes(roleCodes);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>为角色标识加上ROLE_前缀（Spring Security规范）</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">roleCodes = roleCodes.stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(rc -&gt; &quot;ROLE_&quot; + rc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>合并角色权限，以‘，’分开权限：</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//角色是一种特殊的权限，所以合并</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">authorities.addAll(roleCodes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//转成用逗号分隔的字符串，为用户设置权限标识</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">userDetails.setAuthorities(AuthorityUtils.commaSeparatedStringToAuthorityList(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String.join(&quot;,&quot;, authorities)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>最后返回实体类，加上@Component到类上即可即可</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">return userDetails;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>完整的示例代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyUserDetailService implements UserDetailsService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private MyUserDetailsServiceMapper mapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 用户基础数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyUserDetails userDetails = mapper.findByUserName(username);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (userDetails == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new UsernameNotFoundException(&quot;用户名不存在&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;current user enable: &quot; + userDetails.isEnabled());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 用户角色列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; roleCodes = mapper.findRoleByUserName(username);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 根据角色列表加载当前用户具有的权限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; authorities = mapper.findAuthorityByRoleCodes(roleCodes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //为角色标识加上ROLE_前缀（Spring Security规范）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        roleCodes = roleCodes.stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(rc -&gt; &quot;ROLE_&quot; + rc)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //角色是一种特殊的权限，所以合并</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authorities.addAll(roleCodes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        //转成用逗号分隔的字符串，为用户设置权限标识</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        userDetails.setAuthorities(AuthorityUtils.commaSeparatedStringToAuthorityList(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String.join(&quot;,&quot;, authorities)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(userDetails);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return userDetails;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="实现后的配置">实现后的配置<a class="hash-link" href="#实现后的配置" title="标题的直接链接">​</a></h4><p>完成以后，在Spring Security的配置类中，注入Service，配置AuthenticationManagerBuilder：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private MyUserDetailService myUserDetailService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void configure(AuthenticationManagerBuilder auth) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auth.userDetailsService(myUserDetailService)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .passwordEncoder(passwordEncoder());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="资源鉴权规则">资源鉴权规则<a class="hash-link" href="#资源鉴权规则" title="标题的直接链接">​</a></h3><p>简而言之：当前访问的路径和当前用户所拥有权限的路径是否匹配</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建一个rbac类">创建一个RBAC类<a class="hash-link" href="#创建一个rbac类" title="标题的直接链接">​</a></h4><ol><li>创建一个属于自己的RBAC类</li></ol><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyRBACService</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><ol start="2"><li>定义一个方法，方法名可以自拟，方法固定</li></ol><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public boolean hasPermission(HttpServletRequest request, Authentication authentication)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><ol start="3"><li>获取主体信息 -&gt; 判断是否是UserDetails -&gt; 转换 -&gt; 获取本次访问的资源（路径） -&gt; 判断主体是否含有这个资源 -&gt; 返回</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public boolean hasPermission(HttpServletRequest request, Authentication authentication) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当前认证的主体信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Object principal = authentication.getPrincipal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (principal instanceof UserDetails) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UserDetails userDetails = (UserDetails) principal;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 本次要访问的资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SimpleGrantedAuthority simpleGrantedAuthority</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            = new SimpleGrantedAuthority(request.getRequestURI());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // userDetails.getAuthorities()该用户所能访问的所有资源</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return userDetails.getAuthorities().contains(simpleGrantedAuthority);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置类更换">配置类更换<a class="hash-link" href="#配置类更换" title="标题的直接链接">​</a></h4><p>原先在配置类中配置写死的方法就可以去除：</p><p><img loading="lazy" src="https://gitee.com/kyrzy0416/imagebed/raw/master/img/image-20210529162007567.png" alt="image-20210529162007567" class="img_ev3q"></p><p>将antMatchers().hasAuthority换为这个SPEL表达式即可：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.anyRequest().access(&quot;@rbacService.hasPermission(request,authentication)&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spel权限表达式">SPEL权限表达式<a class="hash-link" href="#spel权限表达式" title="标题的直接链接">​</a></h2><p>Spring Express Language</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="常用权限表达式">常用权限表达式<a class="hash-link" href="#常用权限表达式" title="标题的直接链接">​</a></h3><table><thead><tr><th align="left">表达式函数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>hasRole([role]</code>)</td><td align="left">用户拥有指定的角色时返回true （<code>Spring security</code>默认会带有<code>ROLE_</code>前缀）,去除前缀参考<a href="https://github.com/spring-projects/spring-security/issues/4134" target="_blank" rel="noopener noreferrer">Remove the ROLE_</a></td></tr><tr><td align="left"><code>hasAnyRole([role1,role2])</code></td><td align="left">用户拥有任意一个指定的角色时返回true</td></tr><tr><td align="left"><code>hasAuthority([authority])</code></td><td align="left">拥有某资源的访问权限时返回true</td></tr><tr><td align="left"><code>hasAnyAuthority([auth1,auth2])</code></td><td align="left">拥有某些资源其中部分资源的访问权限时返回true</td></tr><tr><td align="left"><code>permitAll</code></td><td align="left">永远返回true</td></tr><tr><td align="left"><code>denyAll</code></td><td align="left">永远返回false</td></tr><tr><td align="left"><code>anonymous</code></td><td align="left">当前用户是<code>anonymous</code>时返回true</td></tr><tr><td align="left"><code>rememberMe</code></td><td align="left">当前用户是<code>rememberMe</code>用户返回true</td></tr><tr><td align="left"><code>authentication</code></td><td align="left">当前登录用户的<code>authentication</code>对象</td></tr><tr><td align="left"><code>fullAuthenticated</code></td><td align="left">当前用户既不是<code>anonymous</code>也不是<code>rememberMe</code>用户时返回true</td></tr><tr><td align="left"><code>hasIpAddress(&#x27;192.168.1.0/24&#x27;)</code></td><td align="left">请求发送的IP匹配时返回true</td></tr></tbody></table><h4 class="anchor anchorWithStickyNavbar_LWe7" id="permitall权限示例">permitALL()权限示例<a class="hash-link" href="#permitall权限示例" title="标题的直接链接">​</a></h4><p>在security全局配置文件中，我们是这样配置任何人都可以进入的路径的：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.antMatchers(&quot;/login.html&quot;,&quot;/login&quot;).permitAll()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>然而，我们还可以用另外一种方式来实现它：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.antMatchers(&quot;/login.html&quot;,&quot;/login&quot;).access(&quot;permitAll()&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="method表达式安全控制">Method表达式安全控制<a class="hash-link" href="#method表达式安全控制" title="标题的直接链接">​</a></h3><ul><li>@PreAuthorize 注解适合进入方法前的权限验证。</li></ul><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@PreAuthorize(&quot;hasRole(&#x27;admin&#x27;)&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><ul><li>@PostAuthorize 在方法执行后再进行权限验证,适合根据返回值结果进行权限验证。</li></ul><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@PostAuthorize(&quot;returnObject.name == authentication.name&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><ul><li>@PreFilter 针对参数进行过滤,下文代码表示针对ids参数进行过滤，只有id为偶数的元素才被作为参数传入函数。</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//当有多个对象是使用filterTarget进行标注</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@PreFilter(filterTarget=&quot;ids&quot;, value=&quot;filterObject%2==0&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void delete(List&lt;Integer&gt; ids, List&lt;String&gt; usernames) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>@PostFilter 针对返回结果进行过滤，特别适用于集合类返回值，过滤集合中不符合表达式的对象。</li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@PostFilter(&quot;filterObject.name == authentication.name&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;PersonDemo&gt; findAllPD(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;PersonDemo&gt; list = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    list.add(new PersonDemo(&quot;kobe&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    list.add(new PersonDemo(&quot;admin&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在全局配置中开启注解：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MySecurityConfig extends WebSecurityConfigurerAdapter {</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rememberme-记住我">RememberMe 记住我<a class="hash-link" href="#rememberme-记住我" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基础知识">基础知识<a class="hash-link" href="#基础知识" title="标题的直接链接">​</a></h3><p>在Spring Security中，Remember Me的两大核心是</p><p>后端全局配置类加上rememberMe()：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SecurityConfig extends WebSecurityConfigurerAdapter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void configure(HttpSecurity http) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http.rememberMe();   //实现记住我自动登录配置，核心的代码只有这一行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>前端传入用户是否点击了Checkbox：</p><blockquote><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">label</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">input</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">checkbox</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">remember-me</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain">记住密码</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">label</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>它有两个默认行为：</p><ul><li>前后端分离的项目，如果要判断是否为记住我，上传的数据名默认为&quot;remember-me&quot;：</li></ul><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    username</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    password</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;remember-me&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> rememberMe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>2周内免登录</li></ul><p>Spring Security的记住我cookie使用Base64实现的：</p><blockquote><p>YWRtaW46MTYyMzQ5MzU2MTE2NTo2ZTk0NTNlZjkxZDcyYTU1MDU0YTczNWI0Y2I0YmM5Mw</p></blockquote><p>解密后：</p><blockquote><p>admin:1623493561165:6e9453ef91d72a55054a735b4cb4bc93</p></blockquote><p>signatureValue = username、expirationTime和passwod和一个预定义的key，并将他们经过MD5进行签名</p><p>它有这样的执行流程：</p><p><img loading="lazy" src="https://gitee.com/kyrzy0416/imagebed/raw/master/img/e97c1601ac0850797df5683349d486ce_1501x327.png" alt="img" class="img_ev3q"></p><ul><li>第一次登录请求的时候，用户使用其他验证方式进行登录（如用户名密码），勾选remember-me，并生成RememberMeToken 令牌。</li><li>第二次登陆的时候使用RememberMeToken令牌（就不用输入用户名密码了），RememberMeAuthenticationFilter在Spring Security过滤器链中处于整体偏后的位置，所以只有当各种传统的登录方式都无法完成验证的情况下，才走RememberMeAuthenticationFilter，这也是符合实际需求的。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="自定义配置">自定义配置<a class="hash-link" href="#自定义配置" title="标题的直接链接">​</a></h3><p>如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.rememberMe()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .rememberMeParameter(&quot;remember-me-new&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .rememberMeCookieName(&quot;remember-me-cookie&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .tokenValiditySeconds(2 * 24 * 60 * 60);  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>tokenValiditySeconds用于设置token的有效期，即多长时间内可以免除重复登录，单位是秒。不修改配置情况下默认是2周。</li><li>通过rememberMeParameter设置from表单“自动登录”勾选框的参数名称。如果这里改了，from表单中checkbox的name属性要对应的更改。如果不设置默认是remember-me。</li><li>rememberMeCookieName设置了保存在浏览器端的cookie的名称，如果不设置默认也是remember-me。如下图中查看浏览器的cookie。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="数据库实现">数据库实现<a class="hash-link" href="#数据库实现" title="标题的直接链接">​</a></h3><p>流程执行图：</p><p><img loading="lazy" src="https://gitee.com/kyrzy0416/imagebed/raw/master/img/52bfd1be308b140ce4f45df5ad95e23c_1344x517.png" alt="img" class="img_ev3q"></p><ol><li>首先，我们需要键一张数据库表<strong>persistent_logins</strong>:</li></ol><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">persistent_logins</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">username</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">series</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">token</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">last_used</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CURRENT_TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CURRENT_TIMESTAMP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">series</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CHARSET</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">utf8</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>在全局配置文件中加入类，返回PersistentTokenRepository：</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private DataSource dataSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> public PersistentTokenRepository persistentTokenRepository(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     JdbcTokenRepositoryImpl tokenRepository = new JdbcTokenRepositoryImpl();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     tokenRepository.setDataSource(dataSource);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     return tokenRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>在全局配置文件中configure(HttpSecurity http)再加入：</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.rememberMe()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .tokenRepository(persistentTokenRepository())</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="退出登录">退出登录<a class="hash-link" href="#退出登录" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="核心配置">核心配置<a class="hash-link" href="#核心配置" title="标题的直接链接">​</a></h3><p>后端在configure(final HttpSecurity http) 配置：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableWebSecurity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SecSecurityConfig extends WebSecurityConfigurerAdapter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void configure(final HttpSecurity http) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http.logout();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>前端加入默认路径：</p><blockquote><div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">/logout</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">退出</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>在这一过程中，Spring Security的默认行为是：</p><ul><li>当前session失效，即：logout的核心需求，session失效就是访问权限的回收。</li><li>删除当前用户的 remember-me“记住我”功能信息（内存和数据库）</li><li>clear清除当前的 SecurityContext</li><li>重定向到登录页面，loginPage配置项指定的页面</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="自定义配置-1">自定义配置<a class="hash-link" href="#自定义配置-1" title="标题的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> http.logout()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     .logoutUrl(&quot;/signout&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     .logoutSuccessUrl(&quot;/aftersignout.html&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     .deleteCookies(&quot;JSESSIONID&quot;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>logoutUrl  配置改变退出请求的默认路径，当然html退出按钮的请求url也要修改</li><li>logoutSuccessUrl  配置，来显式指定退出之后的跳转页面</li><li>deleteCookies  删除指定的cookie，参数为cookie的名称</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置logoutsuccesshandler">配置LogoutSuccessHandler<a class="hash-link" href="#配置logoutsuccesshandler" title="标题的直接链接">​</a></h3><p>如果要对注销登录的一些业务操作，可以自定义创建类实现LogoutSuccessHandler 的接口：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyLogoutSuccessHandler implements LogoutSuccessHandler</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>在接口函数onLogoutSuccess中实现完了业务，返回response.sendRedirect(&quot;/login.html&quot;);</p><p>完成以后在全局配置configure (HttpSecurity http)中加入logoutSuccessHandler：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">http.logout()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .deleteCookies(&quot;JSESSIONID&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .logoutSuccessHandler(myLogoutSuccessHandler)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>【注意】</strong>实现完LogoutSuccessHandler以后，需要注释logoutUrl(&quot;&quot;)，不然无法使用</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="图片验证">图片验证<a class="hash-link" href="#图片验证" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="引入kaptcha">引入Kaptcha<a class="hash-link" href="#引入kaptcha" title="标题的直接链接">​</a></h3><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.github.penggle</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">kaptcha</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">2.3.2</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">exclusions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">exclusion</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">javax.servlet-api</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">javax.servlet</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">exclusion</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">exclusions</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="引入配置">引入配置<a class="hash-link" href="#引入配置" title="标题的直接链接">​</a></h3><p>详细配置表有如下：</p><table><thead><tr><th>kaptcha.border</th><th>图片边框，合法值：yes , no</th><th>yes</th></tr></thead><tbody><tr><td>kaptcha.border.color</td><td>边框颜色，合法值： r,g,b (and optional alpha) 或者 white,black,blue.</td><td>black</td></tr><tr><td>kaptcha.image.width</td><td>图片宽</td><td>200</td></tr><tr><td>kaptcha.image.height</td><td>图片高</td><td>50</td></tr><tr><td>kaptcha.producer.impl</td><td>图片实现类</td><td>com.google.code.kaptcha.impl.DefaultKaptcha</td></tr><tr><td>kaptcha.textproducer.impl</td><td>文本实现类</td><td>com.google.code.kaptcha.text.impl.DefaultTextCreator</td></tr><tr><td>kaptcha.textproducer.char.string</td><td>文本集合，验证码值从此集合中获取</td><td>abcde2345678gfynmnpwx</td></tr><tr><td>kaptcha.textproducer.char.length</td><td>验证码长度</td><td>5</td></tr><tr><td>kaptcha.textproducer.font.names</td><td>字体</td><td>Arial, Courier</td></tr><tr><td>kaptcha.textproducer.font.size</td><td>字体大小</td><td>40px.</td></tr><tr><td>kaptcha.textproducer.font.color</td><td>字体颜色，合法值： r,g,b 或者 white,black,blue.</td><td>black</td></tr><tr><td>kaptcha.textproducer.char.space</td><td>文字间隔</td><td>2</td></tr><tr><td>kaptcha.noise.impl</td><td>干扰实现类</td><td>com.google.code.kaptcha.impl.DefaultNoise</td></tr><tr><td>kaptcha.noise.color</td><td>干扰 颜色，合法值： r,g,b 或者 white,black,blue.</td><td>black</td></tr><tr><td>kaptcha.obscurificator.impl</td><td>图片样式：<br>水纹 com.google.code.kaptcha.impl.WaterRipple <br>鱼眼 com.google.code.kaptcha.impl.FishEyeGimpy <br>阴影 com.google.code.kaptcha.impl.ShadowGimpy</td><td>com.google.code.kaptcha.impl.WaterRipple</td></tr><tr><td>kaptcha.background.impl</td><td>背景实现类</td><td>com.google.code.kaptcha.impl.DefaultBackground</td></tr><tr><td>kaptcha.background.clear.from</td><td>背景颜色渐变，开始颜色</td><td>light grey</td></tr><tr><td>kaptcha.background.clear.to</td><td>背景颜色渐变， 结束颜色</td><td>white</td></tr><tr><td>kaptcha.word.impl</td><td>文字渲染器</td><td>com.google.code.kaptcha.text.impl.DefaultWordRenderer</td></tr><tr><td>kaptcha.session.key</td><td>session key</td><td>KAPTCHA_SESSION_KEY</td></tr><tr><td>kaptcha.session.date</td><td>session date</td><td>KAPTCHA_SESSION_DATE</td></tr></tbody></table><p>在Spring Boot中我们不能使用YAML的方式，只能使用Properties的方式来配置：</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kaptcha.border=no</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kaptcha.border.color=105,179,90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kaptcha.image.width=100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kaptcha.image.height=45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kaptcha.textproducer.font.color=blue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kaptcha.textproducer.font.size=35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kaptcha.textproducer.char.length=4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kaptcha.textproducer.font.names=宋体,楷体,微软雅黑</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>配置完之后创建配置类，倒入配置信息：</p><ul><li>使用@Value从配置中导入值</li><li>创建DefaultKaptcha 方法，一般取名为：kaptchaProducer，加上@Bean注解<ul><li>实例化DefaultKaptcha、Properties 类</li><li>利用properties.setProperty导入配置</li><li>实例化Config 类，传入properties</li><li>DefaultKaptcha利用设置配置的方法</li><li>返回DefaultKaptcha</li></ul></li><li>加上@Component注解和@PropertySource（标注peoperties的位置）</li></ul><p>示例代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@PropertySource(value = {&quot;classpath:kaptcha.properties&quot;})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CaptchaConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${kaptcha.border}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String border;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${kaptcha.border.color}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String borderColor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${kaptcha.textproducer.font.color}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String fontColor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${kaptcha.image.width}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String imageWidth;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${kaptcha.image.height}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String imageHeight;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${kaptcha.textproducer.char.length}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String charLength;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${kaptcha.textproducer.font.names}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String fontNames;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${kaptcha.textproducer.font.size}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String fontSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean(name = &quot;captchaProducer&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DefaultKaptcha getKaptchaBean() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultKaptcha defaultKaptcha = new DefaultKaptcha();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.setProperty(&quot;kaptcha.border&quot;, border);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.setProperty(&quot;kaptcha.border.color&quot;, borderColor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.setProperty(&quot;kaptcha.textproducer.font.color&quot;, fontColor);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.setProperty(&quot;kaptcha.image.width&quot;, imageWidth);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.setProperty(&quot;kaptcha.image.height&quot;, imageHeight);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.setProperty(&quot;kaptcha.session.key&quot;, sessionKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.setProperty(&quot;kaptcha.textproducer.char.length&quot;, charLength);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.setProperty(&quot;kaptcha.textproducer.font.names&quot;, fontNames);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        properties.setProperty(&quot;kaptcha.textproducer.font.size&quot;,fontSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Config config = new Config(properties);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        defaultKaptcha.setConfig(config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return defaultKaptcha;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="验证码在session中的生成">验证码在Session中的生成<a class="hash-link" href="#验证码在session中的生成" title="标题的直接链接">​</a></h3><p>导读：</p><ul><li>captchaProducer.createText() 生成验证码文字</li><li>KaptchaForm 保存Session中验证码的信息（验证码、过期时间）</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建验证码信息类">创建验证码信息类<a class="hash-link" href="#创建验证码信息类" title="标题的直接链接">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class KaptchaForm {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String code;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public LocalDateTime expireTime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public KaptchaForm(String code, int expireAfterSeconds) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.code = code;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.expireTime = LocalDateTime.now().plusSeconds(expireAfterSeconds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isExpired() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return LocalDateTime.now().isAfter(expireTime);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getCode() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return code;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="把验证码传到session前端">把验证码传到Session前端<a class="hash-link" href="#把验证码传到session前端" title="标题的直接链接">​</a></h4><p>创建一个Controller：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class KaptchaController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private DefaultKaptcha kaptchaProducer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/kaptcha&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void kaptcha(HttpSession session, HttpServletResponse response) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setDateHeader(&quot;Expires&quot;, 0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setHeader(&quot;Cache-Control&quot;, &quot;no-store, no-cache, must-revalidate&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.addHeader(&quot;Cache-Control&quot;, &quot;post-check=0, pre-check=0&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setHeader(&quot;Pragma&quot;, &quot;no-cache&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setContentType(&quot;image/jpeg&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String kaptchaText = kaptchaProducer.createText();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        session.setAttribute(MyContent.KAPTCHA_SESSION_KEY, new KaptchaForm(kaptchaText, 2*60));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try(ServletOutputStream out = response.getOutputStream()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            BufferedImage defaultKaptchaImage = kaptchaProducer.createImage(kaptchaText);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ImageIO.write(defaultKaptchaImage, &quot;jpg&quot;, out);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            out.flush();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在前端，可以置随机数改变验证码的内容：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onload</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> kaptchaImg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getElementById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kaptcha&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        kaptchaImg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onclick</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            kaptchaImg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/kaptcha?&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">floor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token known-class-name class-name">Math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">random</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">script</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="实现后端验证--验证码">实现后端验证--验证码<a class="hash-link" href="#实现后端验证--验证码" title="标题的直接链接">​</a></h4><p>执行流程图如下：</p><p><img loading="lazy" src="https://gitee.com/kyrzy0416/imagebed/raw/master/img/e247197a4faf4269d8fb61e914538acf_741x180.png" alt="img" class="img_ev3q"></p><ul><li>编写我们的自定义图片验证码过滤器KaptchaCodeFilter，过滤器中拦截登录请求</li><li>KaptchaCodeFilter过滤器中从seesion获取验证码文字与用户输入比对，比对通过执行其他过滤器链</li><li>比对不通过，抛出SessionAuthenticationException异常，交给AuthenticationFailureHandler处理</li><li>最后将KaptchaCodeFilter放在UsernamePasswordAuthenticationFilter表单过滤器之前执行。</li></ul><p>首先，创建一个Filter类继承OncePerRequestFilter </p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class KaptchaFilter extends OncePerRequestFilte</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>实现doFilterInternal函数，在里面主要做前端传入的验证码是否正确的校验</p><p>获取前端校验码：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">String codeInRequest = ServletRequestUtils.getStringParameter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        request.getRequest(),&quot;kaptchaCode&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>获取Session中的验证码：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">KaptchaForm codeInSession = (KaptchaForm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        session.getAttribute(放入Session中的key);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>接着就可以判断验证码：空、过期、不匹配的操作，如果成功就不做操作，放行；如果失败则拦截，拦截代码如下：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">filterChain.doFilter(request, response);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>最后在类上加上@Component注解，完整的示例代码如下：</p><p>注：return 放在catch中，如果放在外面前端会返回undefined</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class KaptchaFilter extends OncePerRequestFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private MyAuthenticationFailureHandler authenticationFailureHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void doFilterInternal(HttpServletRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    FilterChain filterChain) throws ServletException, IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StrUtil.equals(&quot;/login&quot;, request.getRequestURI())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &amp;&amp; StrUtil.equalsIgnoreCase(request.getMethod(), &quot;POST&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 验证谜底与用户输入是否匹配</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                validate(new ServletWebRequest(request));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (AuthenticationException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                authenticationFailureHandler.onAuthenticationFailure(request,response, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filterChain.doFilter(request, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void validate(ServletWebRequest request) throws ServletRequestBindingException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpSession session = request.getRequest().getSession();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取用户登录界面输入的kaptchaCode(前端AJAX传入)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String codeInRequest = ServletRequestUtils.getStringParameter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                request.getRequest(),&quot;kaptchaCode&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(StrUtil.isEmpty(codeInRequest)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SessionAuthenticationException(&quot;验证码不能为空&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取session池中的验证码谜底</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        KaptchaForm codeInSession = (KaptchaForm)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                session.getAttribute(MyContent.KAPTCHA_SESSION_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(codeInSession.getCode());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(Objects.isNull(codeInSession)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SessionAuthenticationException(&quot;验证码不存在&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 校验服务器session池中的验证码是否过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(codeInSession.isExpired()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            session.removeAttribute(MyContent.KAPTCHA_SESSION_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SessionAuthenticationException(&quot;验证码已经过期&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 请求验证码校验</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(!StrUtil.equals(codeInSession.getCode(), codeInRequest)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new SessionAuthenticationException(&quot;验证码不匹配&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最后在全局配置类中（configure (HttpSecurity http)）中加入addFilterBefore即可：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void configure (HttpSecurity http) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http.addFilterBefore(kaptchaFilter, UsernamePasswordAuthenticationFilter.class)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至此，验证码的功能都实现了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前后端分离的应用">前后端分离的应用<a class="hash-link" href="#前后端分离的应用" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="jwt工具类">JWT工具类<a class="hash-link" href="#jwt工具类" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="jwt工具类模板-1">JWT工具类模板 1<a class="hash-link" href="#jwt工具类模板-1" title="标题的直接链接">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="引入jwt工具包">引入JWT工具包<a class="hash-link" href="#引入jwt工具包" title="标题的直接链接">​</a></h5><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">io.jsonwebtoken</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jjwt</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">0.9.1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在YAML文件中配置：</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">jwt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">header</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> JWTHeaderName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">secret</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aabbccdd  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">expiration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3600000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>secret是用来为JWT基础信息加密和解密的密钥</li><li>expiration是JWT令牌的有效时间（毫秒）</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="jwt模板引入">JWT模板引入<a class="hash-link" href="#jwt模板引入" title="标题的直接链接">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;jwt&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JWTUtil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String secret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Long expiration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String header;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 生成token令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param userDetails 用户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 令token牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String generateToken(UserDetails userDetails) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, Object&gt; claims = new HashMap&lt;&gt;(2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claims.put(&quot;sub&quot;, userDetails.getUsername());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        claims.put(&quot;created&quot;, new Date());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return generateToken(claims);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 从令牌中获取用户名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param token 令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 用户名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsernameFromToken(String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Claims claims = getClaimsFromToken(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            username = claims.getSubject();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            username = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 判断令牌是否过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param token 令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 是否过期</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Boolean isTokenExpired(String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Claims claims = getClaimsFromToken(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Date expiration = claims.getExpiration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return expiration.before(new Date());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 刷新令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param token 原令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 新令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String refreshToken(String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String refreshedToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Claims claims = getClaimsFromToken(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            claims.put(&quot;created&quot;, new Date());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            refreshedToken = generateToken(claims);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            refreshedToken = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return refreshedToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 验证令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param token       令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param userDetails 用户</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 是否有效</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Boolean validateToken(String token, UserDetails userDetails) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String username = getUsernameFromToken(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 从claims生成令牌,如果看不懂就看谁调用它</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param claims 数据声明</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String generateToken(Map&lt;String, Object&gt; claims) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Date expirationDate = new Date(System.currentTimeMillis() + expiration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Jwts.builder().setClaims(claims)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .setExpiration(expirationDate)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .signWith(SignatureAlgorithm.HS512, secret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .compact();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 从令牌中获取数据声明,如果看不懂就看谁调用它</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param token 令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return 数据声明</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Claims getClaimsFromToken(String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Claims claims;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            claims = Jwts.parser().setSigningKey(secret).parseClaimsJws(token).getBody();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            claims = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return claims;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="获取token">获取Token<a class="hash-link" href="#获取token" title="标题的直接链接">​</a></h5><p>先序：（官方文档）介绍AuthenticationManager 、SecurityContextHolder、SecurityContext</p><ul><li><p>AuthenticationManager ：AuthenticationManager 是一个API，定义了Spring Security如何过滤的认证方式，然后由调用AuthenticationManager 的控制器在 SecurityContextHolder 上设置返回的身份验证。</p></li><li><p>SecurityContextHolder：SecurityContextHolder是Spring Security存储已认证身份的细节。Spring Security 不关心 SecurityContextHolder 是如何填充的。如果它包含一个值，则将其用作当前经过身份验证的用户。指定用户已通过身份验证的最简单方法是直接设置 SecurityContextHolder。</p></li></ul><p><img loading="lazy" src="https://gitee.com/kyrzy0416/imagebed/raw/master/img/securitycontextholder.png" alt="securitycontextholder" class="img_ev3q"></p><ul><li>SecurityContext：SecurityContext 是从 SecurityContextHolder 获得的。 SecurityContext 包含一个 Authentication 对象（包含如下信息）<ul><li>主体（principal） - 标识用户。当使用用户名/密码进行身份验证时，这通常是 UserDetails 的一个实例。 </li><li>凭据（credentials） - 通常是密码。在许多情况下，这将在用户通过身份验证后被清除，以确保它不会泄露。 </li><li>权限（authorities） - GrantedAuthoritys 是授予用户的高级权限。一些示例是角色或范围。</li></ul></li></ul><p>认证拦截的流程如下：</p><p><img loading="lazy" src="https://gitee.com/kyrzy0416/imagebed/raw/master/img/abstractauthenticationprocessingfilter.png" alt="abstractauthenticationprocessingfilter" class="img_ev3q"></p><p>有了这些先行知识，我们就可以在全局配置类中创建一个AuthenticationManager：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean(name= BeanIds.AUTHENTICATION_MANAGER)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public AuthenticationManager authenticationManager() throws Exception{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return super.authenticationManager();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>首先创建一个Service，用于对JWTController中对JWT的处理：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JWTAuthService</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>紧接着，要对Login进行处理，当获取当账号和密码时，先对账号和密码创建认证Token：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">UsernamePasswordAuthenticationToken upToken =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new UsernamePasswordAuthenticationToken(username, password);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>在AuthenticationManager中获取用户的权限：</p><blockquote><p>Authentication authenticate = manager.authenticate(upToken);</p></blockquote><p>把用户的权限放入到SecurityContext中，从SecurityContextHolder获取并设置：</p><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SecurityContextHolder.getContext().setAuthentication(authenticate);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>最后生成JWT返回：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">UserDetails userDetails = userDetailsService.loadUserByUsername(username);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return jwtUtil.generateToken(userDetails);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>完整示例代码如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthenticationManager manager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UserDetailsService userDetailsService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JWTUtil jwtUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 登录认证换取JWT令牌</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public String login(String username, String password) throws CustomException{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UsernamePasswordAuthenticationToken upToken =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new UsernamePasswordAuthenticationToken(username, password);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Authentication authenticate = manager.authenticate(upToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SecurityContextHolder.getContext().setAuthentication(authenticate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (AuthenticationException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new CustomException(CustomExceptionType.USER_INPUT_ERROR,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  &quot;用户名或者密码不正确&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UserDetails userDetails = userDetailsService.loadUserByUsername(username);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return jwtUtil.generateToken(userDetails);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最后通过Controller处理响应，刷新令牌同理：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> @PostMapping(&quot;/authentication&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public R login(@RequestBody Map&lt;String, String&gt; map) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String username = map.get(&quot;username&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String password = map.get(&quot;password&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (StrUtil.isEmpty(username) || StrUtil.isEmpty(password)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return R.error(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new CustomException(CustomExceptionType.USER_INPUT_ERROR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                , &quot;用户名或者密码不能为空&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return R.success(jwtAuthService.login(username, password));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (CustomException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return R.error(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>刷新令牌的业务层处理和控制层处理如下：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* 刷新令牌(controller)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* @return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@PostMapping(&quot;/refreshToken&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public R refresh(@RequestHeader(&quot;token&quot;) String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return R.success(jwtAuthService.refreshToken(token));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public String refreshToken(String oldToken) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!jwtUtil.isTokenExpired(oldToken)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return jwtUtil.refreshToken(oldToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="接口访问鉴权过滤器">接口访问鉴权过滤器<a class="hash-link" href="#接口访问鉴权过滤器" title="标题的直接链接">​</a></h5><p>定义一个拦截器：</p><ul><li>拦截接口请求，从请求request获取token，从token中解析得到用户名</li><li>通过UserDetailsService获得系统用户（从数据库、或其他其存储介质）</li><li>根据用户信息和JWT令牌，验证系统用户与用户输入的一致性，并判断JWT是否过期。如果没有过期，至此表明了该用户的确是该系统的用户。</li><li>系统用户不代表你可以访问所有的接口。所以需要构造UsernamePasswordAuthenticationToken传递用户、权限信息，并将这些信息通过authentication告知Spring Security。Spring Security会以此判断你的接口访问权限。</li></ul><p>注意：</p><ol><li>这里之所以能获取到身份权限，是因为在登录时设置了权限：</li></ol><blockquote><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SecurityContextHolder.getContext().setAuthentication(authenticate);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><ol start="2"><li>携带@Component注解</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JwtAuthenticationTokenFilter extends OncePerRequestFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    JWTUtil jwtUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyUserDetailService userDetailService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void doFilterInternal(HttpServletRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    FilterChain filterChain) throws ServletException, IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String token = request.getHeader(jwtUtil.getHeader());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (token != null &amp;&amp; StrUtil.isNotEmpty(token)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String username = jwtUtil.getUsernameFromToken(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // JWT中提取用户信息，并且该用户未被授权</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (username != null &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                UserDetails userDetails = userDetailService.loadUserByUsername(username);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (jwtUtil.validateToken(token, userDetails)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //给使用该JWT令牌的用户进行授权</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    UsernamePasswordAuthenticationToken authenticationToken =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filterChain.doFilter(request, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置cors解决跨站访问">配置CORS解决跨站访问<a class="hash-link" href="#配置cors解决跨站访问" title="标题的直接链接">​</a></h3><p>在spring security的WebSecurityConfigurerAdapter中的configure(HttpSecurity http)配置方法，加上http.cors()配置</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class WebSecurityConfig extends WebSecurityConfigurerAdapter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void configure(HttpSecurity http) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http.cors().and()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同样在全局配置文件中，Spring Security为我们提供了一种新的CORS规则的配置方法：CorsConfigurationSource 。使用这种方法实现的效果等同于注入一个CorsFilter过滤器。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CorsConfigurationSource corsConfigurationSource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CorsConfiguration configuration = new CorsConfiguration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configuration.setAllowedOrigins(Arrays.asList(&quot;http://localhost:8888&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configuration.setAllowedMethods(Arrays.asList(&quot;GET&quot;,&quot;POST&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    configuration.applyPermitDefaultValues();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    source.registerCorsConfiguration(&quot;/**&quot;, configuration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return source;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/zhiyu1998/Computer-Science-Learn-Notes/edit/master/docs/Java/fm/SpringSecurity.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/Computer-Science-Learn-Notes/docs/Java/fm/SpringDataJpa"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">SpringDataJpa</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Computer-Science-Learn-Notes/docs/Java/fm/SpringCloud"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">SpringCloud</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#spring-security-对比-shiro" class="table-of-contents__link toc-highlight">Spring Security 对比 Shiro</a><ul><li><a href="#spring-security-核心" class="table-of-contents__link toc-highlight">Spring Security 核心</a></li><li><a href="#对比shiro" class="table-of-contents__link toc-highlight">对比shiro</a></li></ul></li><li><a href="#http-basic认证模式" class="table-of-contents__link toc-highlight">Http Basic认证模式</a><ul><li><a href="#http-basic不够安全的原因" class="table-of-contents__link toc-highlight">Http Basic不够安全的原因</a></li></ul></li><li><a href="#hash算法" class="table-of-contents__link toc-highlight">Hash算法</a><ul><li><a href="#passwordencoder-接口" class="table-of-contents__link toc-highlight">PasswordEncoder 接口</a></li></ul></li><li><a href="#formlogin登录模式" class="table-of-contents__link toc-highlight">formLogin登录模式</a><ul><li><a href="#认证初体验" class="table-of-contents__link toc-highlight">认证初体验</a></li><li><a href="#源码解析" class="table-of-contents__link toc-highlight">源码解析</a></li><li><a href="#自定义验证登录处理重要" class="table-of-contents__link toc-highlight">自定义验证登录处理【重要】</a></li><li><a href="#session会话安全管理器" class="table-of-contents__link toc-highlight">Session会话安全管理器</a></li></ul></li><li><a href="#rbac权限模型" class="table-of-contents__link toc-highlight">RBAC权限模型</a></li><li><a href="#动态加载rbac数据" class="table-of-contents__link toc-highlight">动态加载RBAC数据</a><ul><li><a href="#实现dao层接口和service接口" class="table-of-contents__link toc-highlight">实现Dao层接口和Service接口</a></li><li><a href="#资源鉴权规则" class="table-of-contents__link toc-highlight">资源鉴权规则</a></li></ul></li><li><a href="#spel权限表达式" class="table-of-contents__link toc-highlight">SPEL权限表达式</a><ul><li><a href="#常用权限表达式" class="table-of-contents__link toc-highlight">常用权限表达式</a></li><li><a href="#method表达式安全控制" class="table-of-contents__link toc-highlight">Method表达式安全控制</a></li></ul></li><li><a href="#rememberme-记住我" class="table-of-contents__link toc-highlight">RememberMe 记住我</a><ul><li><a href="#基础知识" class="table-of-contents__link toc-highlight">基础知识</a></li><li><a href="#自定义配置" class="table-of-contents__link toc-highlight">自定义配置</a></li><li><a href="#数据库实现" class="table-of-contents__link toc-highlight">数据库实现</a></li></ul></li><li><a href="#退出登录" class="table-of-contents__link toc-highlight">退出登录</a><ul><li><a href="#核心配置" class="table-of-contents__link toc-highlight">核心配置</a></li><li><a href="#自定义配置-1" class="table-of-contents__link toc-highlight">自定义配置</a></li><li><a href="#配置logoutsuccesshandler" class="table-of-contents__link toc-highlight">配置LogoutSuccessHandler</a></li></ul></li><li><a href="#图片验证" class="table-of-contents__link toc-highlight">图片验证</a><ul><li><a href="#引入kaptcha" class="table-of-contents__link toc-highlight">引入Kaptcha</a></li><li><a href="#引入配置" class="table-of-contents__link toc-highlight">引入配置</a></li><li><a href="#验证码在session中的生成" class="table-of-contents__link toc-highlight">验证码在Session中的生成</a></li></ul></li><li><a href="#前后端分离的应用" class="table-of-contents__link toc-highlight">前后端分离的应用</a><ul><li><a href="#jwt工具类" class="table-of-contents__link toc-highlight">JWT工具类</a></li><li><a href="#配置cors解决跨站访问" class="table-of-contents__link toc-highlight">配置CORS解决跨站访问</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">文档</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/Computer-Science-Learn-Notes/docs/intro">主页</a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="#" class="footer__link-item">莫得</a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/zhiyu1998" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Computer Science Learn Notes, Inc. Built with Zhiyu1998.</div></div></div></footer></div>
<script src="/Computer-Science-Learn-Notes/assets/js/runtime~main.2a55ec46.js"></script>
<script src="/Computer-Science-Learn-Notes/assets/js/main.1a67b453.js"></script>
</body>
</html>